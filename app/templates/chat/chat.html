{% extends "base.html" %}

{% block title %}Chat - AI Platform{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-100 dark:bg-gray-900" id="app">
    <!-- Sidebar -->
    <div class="w-64 bg-gray-900 text-white flex flex-col">
        <div class="p-4 border-b border-gray-700">
            <h1 class="text-xl font-bold">AI Platform</h1>
            <p class="text-sm text-gray-400">{{ current_user.username }}</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <button onclick="newChat()" class="w-full text-left px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 transition">
                + New Chat
            </button>
            <a href="{{ url_for('main.pricing') }}" class="block px-4 py-2 rounded-lg hover:bg-gray-800 transition">
                {% if current_user.is_premium() %}
                    âœ¨ Premium ({{ current_user.tier }})
                {% else %}
                    Upgrade to Premium
                {% endif %}
            </a>
            <a href="{{ url_for('main.about') }}" class="block px-4 py-2 rounded-lg hover:bg-gray-800 transition">
                About
            </a>
            <a href="{{ url_for('main.faq') }}" class="block px-4 py-2 rounded-lg hover:bg-gray-800 transition">
                FAQ
            </a>
            {% if current_user.is_admin() %}
            <a href="{{ url_for('admin.index') }}" class="block px-4 py-2 rounded-lg hover:bg-gray-800 transition">
                ðŸ‘‘ Admin Panel
            </a>
            {% endif %}
        </nav>
        
        <div class="p-4 border-t border-gray-700 space-y-2">
            <div class="text-sm text-gray-400">
                <span id="usage-info">Loading usage...</span>
            </div>
            <button onclick="toggleDarkMode()" class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-800 transition">
                ðŸŒ“ Dark/Light Mode
            </button>
            <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 rounded-lg hover:bg-gray-800 transition text-red-400">
                Logout
            </a>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col">
        <!-- Header with Model Selector -->
        <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <label for="model-select" class="text-sm font-medium text-gray-700 dark:text-gray-300">Model:</label>
                <select id="model-select" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="auto">Auto-Select (Recommended)</option>
                    <!-- Models will be loaded dynamically -->
                </select>
            </div>
            <div class="text-sm text-gray-500 dark:text-gray-400" id="model-info">
                Auto mode will select the best model for your task
            </div>
        </div>
        
        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4">
            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
                <p class="mt-4">Start a conversation with AI</p>
                <p class="text-sm mt-2">Choose a model or use auto-mode for intelligent routing:</p>
                <div class="mt-4 text-left max-w-xl mx-auto space-y-2 text-sm">
                    <p>â€¢ <strong>DeepSeek Coder</strong> - For coding and programming tasks</p>
                    <p>â€¢ <strong>Llama.cpp</strong> - For documents and large files</p>
                    <p>â€¢ <strong>Vicuna</strong> - For images and videos</p>
                    <p>â€¢ <strong>GPT4All</strong> - For general chat</p>
                </div>
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4">
            <div class="max-w-4xl mx-auto">
                <form id="chat-form" class="flex space-x-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <textarea 
                        id="message-input" 
                        rows="1" 
                        class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"
                        placeholder="Type your message... (Shift+Enter for new line)"
                        style="min-height: 52px; max-height: 200px;"
                    ></textarea>
                    <button 
                        type="submit" 
                        id="send-button"
                        class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Send
                    </button>
                </form>
                <div class="mt-2 text-xs text-gray-500 dark:text-gray-400 text-center">
                    Rate limit: <span id="rate-limit-info">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const csrfToken = '{{ csrf_token() }}';
let currentModel = 'auto';
let isLoading = false;

// Load models
async function loadModels() {
    try {
        const response = await fetch('/chat/models');
        const data = await response.json();
        const select = document.getElementById('model-select');
        
        // Clear existing options except auto
        select.innerHTML = '<option value="auto">Auto-Select (Recommended)</option>';
        
        data.models.forEach(model => {
            if (model.id !== 'auto') {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = `${model.name} - ${model.use_case || model.description}`;
                select.appendChild(option);
            }
        });
    } catch (error) {
        console.error('Error loading models:', error);
    }
}

// Load usage info
async function loadUsage() {
    try {
        const response = await fetch('/api/usage');
        const data = await response.json();
        document.getElementById('usage-info').textContent = 
            `${data.messages_today}/${data.rate_limit} messages today`;
        document.getElementById('rate-limit-info').textContent = 
            `${data.messages_today}/${data.rate_limit} messages used today`;
    } catch (error) {
        console.error('Error loading usage:', error);
    }
}

// Model selector change
document.getElementById('model-select').addEventListener('change', (e) => {
    currentModel = e.target.value;
    const info = document.getElementById('model-info');
    if (currentModel === 'auto') {
        info.textContent = 'Auto mode will select the best model for your task';
    } else {
        const option = e.target.selectedOptions[0];
        info.textContent = option.textContent.split(' - ')[1] || '';
    }
});

// Send message
document.getElementById('chat-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (isLoading) return;
    
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Disable input
    isLoading = true;
    input.disabled = true;
    document.getElementById('send-button').disabled = true;
    
    // Add user message to chat
    addMessage('user', message);
    input.value = '';
    
    // Show loading indicator
    const loadingId = addMessage('assistant', '...', true);
    
    try {
        const response = await fetch('/chat/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                message: message,
                model: currentModel
            })
        });
        
        const data = await response.json();
        
        // Remove loading indicator
        document.getElementById(loadingId)?.remove();
        
        if (response.ok) {
            addMessage('assistant', data.response, false, data.model);
            loadUsage(); // Update usage stats
        } else {
            addMessage('assistant', `Error: ${data.error}`, false, null, true);
        }
    } catch (error) {
        document.getElementById(loadingId)?.remove();
        addMessage('assistant', `Error: ${error.message}`, false, null, true);
    } finally {
        isLoading = false;
        input.disabled = false;
        document.getElementById('send-button').disabled = false;
        input.focus();
    }
});

// Add message to chat
function addMessage(role, content, isLoading = false, model = null, isError = false) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageId = 'msg-' + Date.now();
    
    const messageDiv = document.createElement('div');
    messageDiv.id = messageId;
    messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
    
    let bgColor = role === 'user' ? 'bg-indigo-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white';
    if (isError) bgColor = 'bg-red-100 dark:bg-red-900 text-red-900 dark:text-red-100';
    
    let renderedContent = content;
    if (!isLoading && role === 'assistant') {
        renderedContent = marked.parse(content);
        // Highlight code blocks
        setTimeout(() => {
            messageDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }, 100);
    }
    
    messageDiv.innerHTML = `
        <div class="max-w-3xl px-4 py-3 rounded-lg ${bgColor}">
            ${model ? `<div class="text-xs opacity-75 mb-1">Model: ${model}</div>` : ''}
            <div class="prose prose-sm dark:prose-invert max-w-none ${role === 'user' ? 'text-white' : ''}">${renderedContent}</div>
        </div>
    `;
    
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    return messageId;
}

// New chat
function newChat() {
    const messagesDiv = document.getElementById('chat-messages');
    messagesDiv.innerHTML = `
        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
            <p class="mt-4">Start a conversation with AI</p>
        </div>
    `;
}

// Dark mode toggle
function toggleDarkMode() {
    document.documentElement.classList.toggle('dark');
    localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
}

// Auto-resize textarea
document.getElementById('message-input').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 200) + 'px';
});

// Handle Shift+Enter for new line, Enter for submit
document.getElementById('message-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('chat-form').dispatchEvent(new Event('submit'));
    }
});

// Initialize dark mode
if (localStorage.getItem('darkMode') === 'true') {
    document.documentElement.classList.add('dark');
}

// Load initial data
loadModels();
loadUsage();
</script>
{% endblock %}
